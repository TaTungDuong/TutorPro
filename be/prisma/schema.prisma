generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
  PARENT
  TUTOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum ClassStatus {
  PENDING
  APPROVED
  CLOSED
  CANCELLED
}

enum ApplicationStatus {
  APPLIED
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  REJECTED
}

enum ComplaintStatus {
  OPEN
  APPROVED
  REJECTED
  RESOLVED
}

model User {
  id        Int        @id @default(autoincrement())
  email     String     @unique
  password  String
  role      UserRole
  status    UserStatus @default(ACTIVE)

  staff     Staff?
  parent    Parent?
  tutor     Tutor?
  logs      Log[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Log {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  target    String
  timestamp DateTime @default(now())
  ipAddress String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
}

model Staff {
  id          Int    @id @default(autoincrement())
  userId      Int    @unique
  department  String
  position    String
  status      String

  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes     Class[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Parent {
  id        Int    @id @default(autoincrement())
  userId    Int    @unique
  phone     String
  address   String
  name      String

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes   Class[]
  students  Student[]
  payments  Payment[] @relation("ParentPayment")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tutor {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  specialization String
  availableTime  DateTime?
  feeProposal    Float
  feedback       String?

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications   Application[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Class {
  id        Int        @id @default(autoincrement())
  classID   String     @unique
  subject   String
  level     String
  location  String
  schedule  String
  fee       String
  status    ClassStatus @default(PENDING)

  parentId  Int
  staffId   Int?

  parent    Parent     @relation(fields: [parentId], references: [id], onDelete: Cascade)
  staff     Staff?     @relation(fields: [staffId], references: [id], onDelete: SetNull)

  applications Application[]
  contract     Contract?
  sessions     Session[]
  payments     Payment[]
  studentLinks StudentClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, parentId])
  @@index([staffId])
}

model Payment {
  id          Int          @id @default(autoincrement())
  payerId     Int
  img         String
  status      PaymentStatus @default(PENDING)
  classId     Int
  confirmer   Int?
  confirmTime DateTime?
  amount      Float

  parent      Parent       @relation("ParentPayment", fields: [payerId], references: [id], onDelete: Cascade)
  class       Class        @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, payerId])
  @@index([classId])
}

model Complaint {
  id          Int            @id @default(autoincrement())
  sessionId   Int
  type        String
  status      ComplaintStatus @default(OPEN)
  result      String?
  description String

  session     Session        @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, sessionId])
}

model Contract {
  id              Int      @id @default(autoincrement())
  classId          Int      @unique
  feeFirstMonth    Float
  centerRate       String
  changeConditions String
  rules            String

  class            Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Session {
  id            Int      @id @default(autoincrement())
  classId       Int
  date          DateTime
  content       String
  attendance    Int
  parentConfirm Int @default(0)

  class         Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  complaints    Complaint[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([classId, date])
}

model Application {
  id         Int              @id @default(autoincrement())
  classId    Int
  tutorId    Int
  matchScore Float
  status     ApplicationStatus @default(APPLIED)

  class      Class            @relation(fields: [classId], references: [id], onDelete: Cascade)
  tutor      Tutor            @relation(fields: [tutorId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([classId, tutorId])
  @@index([classId, status])
}

model Student {
  id             Int      @id @default(autoincrement())
  parentId       Int
  gender         String
  age            Int
  freeTime       String
  target         String
  sessionPerWeek Int
  description    String
  fullName       String
  requirementTutor String

  parent         Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  classLinks     StudentClass[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model StudentClass {
  id        Int     @id @default(autoincrement())
  studentId Int
  classId   Int

  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class     Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([studentId, classId])
  @@index([classId])
}
